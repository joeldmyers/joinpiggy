/**
 * Requirements
 * @author: John Ginsberg
 */
var requirements=function(){var e={}
return e.init=function(){$(document).ready(function(){$("#newButton").on("click",function(e){e.preventDefault(),$("#newList").modal("show")}),$(".add").on("click",requirements.addRequirement),$(".edit").on("click",requirements.editRequirement),$(".del").on("click",requirements.deleteRequirement)})},e.addRequirement=function(e){e.preventDefault(),$("#addEditLabel").html("Add Requirement"),$('#addEdit input[name="qty"]').val("1"),$('#addEdit input[name="name"]').val(""),$('#addEdit input[name="name"]').on("keydown",function(e){$(this).val()&&("undefined"!=typeof requirements.lastTimeout&&clearTimeout(requirements.lastTimeout),requirements.lastTimeout=setTimeout(function(){requirements.searchFor($('#addEdit input[name="name"]').val())},500))}),$('#addEdit input[name="requirement_id"]').val(""),$('#addEdit input[name="search"]').on("keydown",function(e){var t=e.keyCode||e.which
13==t&&(e.preventDefault(),requirements.searchFor($(this).val()))}),$("#addEdit form").off("submit").on("submit",function(e){e.preventDefault(),requirements.getRecommendedItems()}),$("#addEdit .addAll").off("click").on("click",function(e){e.preventDefault(),requirements.addAll()}),$("#recommended").html('<div id="instructions"><span class="glyphicon glyphicon-hand-left"></span> Drag items from the suggested products to recommend them for this requirement</div>'),$("#results").html('<div id="loading"><span class="glyphicon glyphicon-hand-up"></span> Find other products by entering keywords in the box below</div>'),$(".addAll").hide(),setTimeout(function(){$('#addEdit input[name="qty"]').focus()},600),$("#addEdit").modal("show")},e.editRequirement=function(e){e.preventDefault()
var t=$(this).closest("tr")
$("#addEditLabel").html("Edit Requirement"),$('#addEdit input[name="qty"]').val($(".qty",t).html()),$('#addEdit input[name="name"]').val($(".name",t).html()),$('#addEdit input[name="requirement_id"]').val(t.attr("data-requirement-id")),$("#addEdit .addAll").off("click").on("click",function(e){e.preventDefault(),requirements.addAll()}),$("#recommended").html('<div id="instructions"><span class="glyphicon glyphicon-hand-left"></span> Drag items from the suggested products to recommend them for this requirement</div>'),$("#results").html('<div id="loading"><span class="glyphicon glyphicon-hand-up"></span> Find other products by entering keywords in the box below</div>'),$(".addAll").hide(),$.getJSON(_basePath+"/supplies/"+_suppliesId+"/requirements/"+t.attr("data-requirement-id")+"/products.json",null,function(e){e.length&&$("#instructions").hide()
for(var t in e)$('<div data-asin="'+e[t].asin+'" data-title="'+e[t].title+'" data-description="'+e[t].description+'" data-price="'+e[t].price+'"                    data-image="'+e[t].image+'" class="item col-md-12 text-center">                    <div class="remove pull-right" title="Remove">&times;</div>                    <img src="'+e[t].image.replace("_SL160_","_AA75_")+'"><br>                    <div class="title">'+e[t].title+'</div><br>                    <div class="incl">Includes <span class="qty-supplied">'+e[t].qty_in_product+"</span> in a pack</div>                </div>").appendTo($("#recommended"))
$("#recommended").scrollTop(0),requirements.addDeleteEvents(),requirements.addQuantityEditEvents()}),$('#addEdit input[name="search"]').on("keydown",function(e){var t=e.keyCode||e.which
13==t&&(e.preventDefault(),requirements.searchFor($(this).val())),requirements.addDragDropEvents()}),$("#addEdit form").off("submit").on("submit",function(e){e.preventDefault(),requirements.getRecommendedItems()}),$("#addEdit").modal("show")},e.deleteRequirement=function(e){if(e.preventDefault(),!confirm("Are you sure you want to remove this requirement?"))return!1
var t=$(this).closest("tr")
$.ajax({url:_basePath+"/supplies/manage/"+t.attr("data-supplies-id")+"/requirements/"+t.attr("data-requirement-id"),type:"DELETE",context:t,success:function(e){$(this).fadeOut("fast","swing",function(){$(this).remove()})}})},e.searchFor=function(t){t!=e.lastSearch&&(e.lastSearch=t,$("#results").html('<div id="loading">Please wait while we search Amazon.com for products...<br><br><img src="/img/loader-bar.gif"></div>'),$(".addAll").hide(),$.getJSON(_basePath+"/supplies/amazon/search/OfficeProducts/"+encodeURI(t),"",function(e){$("#results").html("")
for(var t in e)$('<div class="col-md-4 result" data-asin="'+e[t].asin+'">                    <div class="select">                        <div class="image"><img src="'+e[t].image+'"></div>                        <div class="price"><span class="value">$'+e[t].price+'</span> (Current)</div>                        <div class="description">'+e[t].title+"</div>                    </div>                </div>").appendTo("#results")
0==e.length?$("#results").html('<div id="loading">No results found. Please try another search below.</div>'):(requirements.addDragDropEvents(),$(".addAll").show())}))},e.addDragDropEvents=function(){$("#results .col-md-4").draggable({appendTo:"#addEdit",helper:function(){return $('<img class="drag-helper" data-asin="'+$(this).attr("data-asin")+'" data-title="'+$(this).find(".description").html()+'" data-description="" data-price="'+$(this).find(".price .value").html().replace("$","")+'"                     src="'+$(this).find(".image img").attr("src").replace("_SL160_","_AA75_")+'">')},cursorAt:{left:5,top:5},revert:function(e){return e?$(this).css("display","none"):$(this).css("display",""),!1}}),$("#recommended").droppable({accept:"#results .col-md-4",drop:function(e,t){$("#instructions").hide(),$('<div data-asin="'+$(t.helper).attr("data-asin")+'" data-title="'+$(t.helper).attr("data-title")+'" data-description="'+$(t.helper).attr("data-description")+'" data-price="'+$(t.helper).attr("data-price")+'"                    data-image="'+$(t.helper).attr("src").replace("_AA75_","_SL160_")+'" class="item col-md-12 text-center">                    <div class="remove pull-right" title="Remove">&times;</div>                    <img src="'+$(t.helper).attr("src")+'"><br>                    <div class="title">'+$(t.helper).attr("data-title")+'</div><br>                    <div class="incl">Includes <span class="qty-supplied">1</span> in a pack</div>                </div>').prependTo(this),$("#recommended").scrollTop(0),requirements.addDeleteEvents(),requirements.addQuantityEditEvents()}})},e.addDeleteEvents=function(){$("#recommended .remove").off("click").on("click",function(e){e.preventDefault()
var t=$(this).closest(".item"),i=t.attr("data-asin")
t.fadeOut(200,function(){$(this).remove(),0==$("#recommended .item").length&&$("#instructions").show(),$('#results .col-md-4[data-asin="'+i+'"]').fadeIn(400)})})},e.addQuantityEditEvents=function(){$(".qty-supplied").off("click").on("click",function(e){if(e.preventDefault(),!($(this).find("input").length>0)){var t=$(this),i=$(this).html(),d=$('<input id="editQty" type="text" size="2" value="'+i+'">')
$(d).on("blur",function(e){t.html($(this).val()),$(this).remove()}).width($(this).width()),$(this).html(""),$(this).append(d),d.focus()}})},e.addAll=function(){0!=$("#results .result").length&&($("#instructions").hide(),$("#results .result").each(function(){$('<div data-asin="'+$(this).attr("data-asin")+'" data-title="'+$(this).find(".description").html()+'" data-description="'+$(this).find(".description").html()+'"                 data-price="'+$(this).find(".price .value").html().replace("$","")+'"                data-image="'+$(this).find(".image img").attr("src")+'" class="item col-md-12 text-center">                <div class="remove pull-right" title="Remove">&times;</div>                <img src="'+$(this).find(".image img").attr("src").replace("_SL160_","_AA75_")+'"><br>                <div class="title">'+$(this).find(".description").html()+'</div><br>                <div class="incl">Includes <span class="qty-supplied">1</span> in a pack</div>            </div>').prependTo($("#recommended")),$(this).hide()}),$("#recommended").scrollTop(0),requirements.addDeleteEvents(),requirements.addQuantityEditEvents())},e.getRecommendedItems=function(){if(""==$('#addEdit input[name="name"]').val()||""==$('#addEdit input[name="qty"]').val()||0==$("#recommended .item").length)return void alert("Please add a quantity and description, and at least 1 product")
var e=[]
$("#recommended .item").each(function(){e.push({asin:$(this).attr("data-asin"),qty_in_product:$(this).find(".qty-supplied").html(),title:$(this).attr("data-title"),description:$(this).attr("data-description"),price:parseFloat($(this).attr("data-price")),image:$(this).attr("data-image")})})
var t={requirement_id:$('#addEdit input[name="requirement_id"]').val(),name:$('#addEdit input[name="name"]').val(),qty:$('#addEdit input[name="qty"]').val(),products:e}
$.ajax({url:_basePath+"/supplies/manage/"+_suppliesId+"/requirements"+($('#addEdit input[name="requirement_id"]').val()?"/"+$('#addEdit input[name="requirement_id"]').val():""),data:t,dataType:"json",type:$('#addEdit input[name="requirement_id"]').val()?"PUT":"POST",success:function(e){var t=$("table#requirements").find('tr[data-requirement-id="'+e.requirement_id+'"]')
t.length?(t.find(".qty").html(e.qty),t.find(".name").html(e.name),t.find(".products").html(e.product_count+(1==e.product_count?" product":" products"))):($("table#requirements").append('<tr data-supplies-id="'+_suppliesId+'" data-requirement-id="'+e.requirement_id+'" data-search-terms="">                        <td><a href="" class="qty edit">'+e.qty+'</a></td>                        <td><a href="" class="name edit">'+e.name+'</a></td>                        <td><a href="" class="products edit">'+e.product_count+(1==e.product_count?" product":" products")+'</a></td>                        <td><a href="" class="del">&times;</a></td>'),$(".edit").on("click",requirements.editRequirement),$(".del").on("click",requirements.deleteRequirement)),$("#addEdit").modal("hide")}})},e.init(),e}()
