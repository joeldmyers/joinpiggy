/* global $, getBrowser, downloadApp, clearCookies */
var Affiliate=function(t){this._cid=null,this._events=["continue","close","app"],this._triggerOn=[],this._defaultOptions={emailEl:null,intUrl:"",onCampaignLoaded:null,onCampaignNotFound:null,onPixelFired:null},this._options=$.extend({},this._defaultOptions,t),this._isAppThankYou="/thankyou"==document.location.pathname,this._emailRegex=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i,this._init(),window._affiliate=this}
Affiliate.prototype.isCampaignLoaded=function(){return null!=this._cid},Affiliate.prototype._init=function(){var t=this,i=""
t._options.emailEl&&(t._options.emailEl instanceof jQuery||(t._options.emailEl=$(t._options.emailEl)),t._options.emailEl.length&&(i=t._options.emailEl.val())),$.getJSON("/frame/affiliate/onload",i?{e:i}:null,function(i){i.hasOwnProperty("id")&&(t._cid=i.id),!t._isAppThankYou&&i.hasOwnProperty("pixel")&&(t._placePixel(i.pixel),t._options.onPixelFired&&t._options.onPixelFired({cid:t._cid,triggerOn:"load"})),t._cid&&i.hasOwnProperty("triggerOn")&&(t._triggerOn=i.triggerOn,$.isArray(t._triggerOn)||(t._triggerOn=[t._triggerOn])),t._attachEventHandlers(),i.hasOwnProperty("tests")&&i.tests&&t._runTests(i.tests),t._cid?t._options.onCampaignLoaded&&t._options.onCampaignLoaded({cid:t._cid,triggerOn:t._triggerOn}):t._options.onCampaignNotFound&&t._options.onCampaignNotFound()})},Affiliate.prototype._attachEventHandlers=function(){for(var t=this,i=0;i<t._events.length;i++){var e=t._events[i]
"app"==e&&t._isAppThankYou?t._triggerAppInstalled():$(".affiliate_"+e).off("click").on("click",{trig:e,self:t},t._attachNextEvent)}},Affiliate.prototype._attachNextEvent=function(t){var i=t.data.self
t.preventDefault()
var e=t.data.trig,a=$(this),o=$(this).attr("data-email-field")
if("continue"==e&&!i._emailRegex.test($(o).val()))return void alert("Please enter a valid email address.")
if(a.attr("data-affiliate-pretrigger")){var n=a.attr("data-affiliate-pretrigger").replace(/[^a-zA-Z0-9 ]/g,"")
typeof window[n]==typeof Function&&window[n]({cid:i._cid,triggerOn:e})}else switch(e){case"continue":i.continuePreTrigger()
break
case"close":i.closePreTrigger()
break
case"app":i.appPreTrigger()}i._trigger(e,a)},Affiliate.prototype._trigger=function(t,i){var e,a,o,n=this,r=$(i.attr("data-email-field")).val()
n._cid&&-1!=n._triggerOn.indexOf(t)?(e=!0,a="/frame/affiliate/ontrigger",o={id:n._cid,trigger:t,e:r}):(e=!1,a="/frame/affiliate/log"+t,o={e:r}),$.getJSON(a,o,function(a){var o=1e3
if(e&&a.hasOwnProperty("pixel")&&(n._placePixel(a.pixel),o=1500),i.attr("data-affiliate-next-url"))setTimeout(function(){e&&n._options.onPixelFired&&n._options.onPixelFired({cid:n._cid,triggerOn:t}),document.location=i.attr("data-affiliate-next-url")},o)
else if(i.attr("data-affiliate-callback")){var l=i.attr("data-affiliate-callback").replace(/[^a-zA-Z0-9 ]/g,"")
typeof window[l]==typeof Function&&setTimeout(function(){e&&n._options.onPixelFired&&n._options.onPixelFired({cid:n._cid,triggerOn:t}),window[l](a)},o)}else setTimeout(function(){switch(e&&n._options.onPixelFired&&n._options.onPixelFired({cid:n._cid,triggerOn:t}),t){case"continue":n.continuePostTrigger(r)
break
case"close":n.closePostTrigger()
break
case"app":n.appPostTrigger()}},o)})},Affiliate.prototype._triggerAppInstalled=function(){var t=this,i=setInterval(function(){var e=$("toolbar#browserappinstalled").attr("version")
if(e){var a=$('<input type="hidden" id="aff_app_installed" value="'+escape(t._options.emailEl.val())+'" data-email-field="#aff_app_installed"></span>').appendTo("body")
t._trigger("app",a),clearInterval(i),i=null}},1e3)},Affiliate.prototype._placePixel=function(t){$(t).appendTo($("body"))},Affiliate.prototype._runTests=function(t){var i=[]
if(t.hasOwnProperty("testEmail")&&1==t.testEmail)if(null==this._options.emailEl)i.push("Email is required and no email field is configured.")
else{var e=this._options.emailEl
0==e.length&&i.push("Email is required and no field could be detected.")}if(t.hasOwnProperty("testTriggers")&&1==t.testTriggers)for(var a=0;a<this._triggerOn.length;a++)if(this._isAppThankYou)"app"==this._triggerOn[a]&&($("toolbar#browserappinstalled").length?$("toolbar#browserappinstalled").attr("version")||i.push("The toolbar version could not be detected on the page. Reload this page once the app is installed."):i.push("The toolbar element could not be detected on the page."))
else if("impression"!=this._triggerOn[a]&&"app"!=this._triggerOn[a])if(0==$(".affiliate_"+this._triggerOn[a]).length)i.push("A field with class 'affiliate_"+this._triggerOn[a]+"' could not be detected on the page.")
else{$(".affiliate_"+this._triggerOn[a]).attr("data-affiliate-next-url")||$(".affiliate_"+this._triggerOn[a]).attr("data-affiliate-callback")||$(".affiliate_"+this._triggerOn[a]).attr("data-affiliate-pretrigger")||i.push("A field with class 'affiliate_"+this._triggerOn[a]+"' is found, but is missing a data-affiliate-next-url or data-affiliate-callback attribute. The default behavior will be triggered.")
var o=$(".affiliate_"+this._triggerOn[a]).attr("data-affiliate-pretrigger")?$(".affiliate_"+this._triggerOn[a]).attr("data-affiliate-pretrigger").replace(/[^a-zA-Z0-9 ]/g,""):null
o&&typeof window[o]!=typeof Function&&i.push("A field with class 'affiliate_"+this._triggerOn[a]+"' is found with a valid data-affiliate-pretrigger attribute, but the function it points to cannot be called.")
var n=$(".affiliate_"+this._triggerOn[a]).attr("data-affiliate-callback")?$(".affiliate_"+this._triggerOn[a]).attr("data-affiliate-callback").replace(/[^a-zA-Z0-9 ]/g,""):null
if(n&&!o&&typeof window[n]!=typeof Function&&i.push("A field with class 'affiliate_"+this._triggerOn[a]+"' is found with a valid data-affiliate-callback attribute, but the function it points to cannot be called."),t.hasOwnProperty("testEmail")&&1==t.testEmail)if($(".affiliate_"+this._triggerOn[a]).attr("data-email-field")){var e=$(".affiliate_"+this._triggerOn[a]).attr("data-email-field")
0==$(e).length&&i.push("A field with class 'affiliate_"+this._triggerOn[a]+"' is found with a data-email-field attribute, but the attribute points to a non-existent field on the page.")}else i.push("A field with class 'affiliate_"+this._triggerOn[a]+"' is found, but is missing a data-email-field attribute.")}i.length?this._showTestResults("Test Results","<ol><li>"+i.join("</li><li>")+"</li></ol>"):console.log("No errors! :)")},Affiliate.prototype._showTestResults=function(t,i){$('    <div id="notifyModal" class="modal fade">        <div class="modal-dialog">            <div class="modal-content">                <!-- dialog body -->                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>                    <h4 class="modal-title">'+t+'</h4>                </div>                <div class="modal-body">                '+i+'                </div>                <!-- dialog buttons -->                <div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal">OK</button></div>            </div>        </div>    </div>').appendTo("body"),$("#notifyModal").on("hide.bs.modal",function(t){$("#notifyModal").remove()}),$("#notifyModal").modal("show")},Affiliate.prototype.getParameterByName=function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]")
var i=new RegExp("[\\?&]"+t+"=([^&#]*)"),e=i.exec(document.location.search)
return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))},Affiliate.prototype.closePreTrigger=function(){var t=this.getParameterByName("pop")
"Chrome"==getBrowser()&&t.indexOf("x")>-1&&this.appInstall()},Affiliate.prototype.closePostTrigger=function(){var t=this.getParameterByName("pop")
t.indexOf("c")>-1?"Chrome"!=getBrowser()&&this.appInstall():window.location.href=this._options.intUrl},Affiliate.prototype.continuePreTrigger=function(){var t=this.getParameterByName("pop")
"Chrome"==getBrowser()&&t.indexOf("c")>-1&&this.appInstall()},Affiliate.prototype.continuePostTrigger=function(t){var i=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i
if(i.test(t)){var e=this.getParameterByName("pop")
e.indexOf("c")>-1?"Chrome"!=getBrowser()&&this.appInstall():window.location.href=this._options.intUrl}else alert("Please enter a valid email address.")},Affiliate.prototype.appPreTrigger=function(){this.appInstall(!0)},Affiliate.prototype.appPostTrigger=function(){},Affiliate.prototype.appInstall=function(t){var i=getBrowser(),e=this.getParameterByName("app"),a=new Date
switch(a.setDate(a.getDate()),a.setMinutes(a.getMinutes()+60),clearCookies("open_url"),i){case"Chrome":t||e.indexOf("c")>-1?($.cookie("open_url",this._options.intUrl,{expires:a,path:"/",domain:"."+document.location.host}),console.log("Cookie set to ",this._options.intUrl),downloadApp()):window.location.href=this._options.intUrl
break
case"IE":t||e.indexOf("i")>-1?($.cookie("open_url",this._options.intUrl,{expires:a,path:"/",domain:"."+document.location.host}),downloadApp()):window.location.href=this._options.intUrl
break
case"Firefox":t||e.indexOf("f")>-1?($.cookie("open_url",this._options.intUrl,{expires:a,path:"/",domain:"."+document.location.host}),downloadApp()):window.location.href=this._options.intUrl
break
case"Safari":t||e.indexOf("s")>-1?($.cookie("open_url",this._options.intUrl,{expires:a,path:"/",domain:"."+document.location.host}),downloadApp()):window.location.href=this._options.intUrl
break
default:window.location.href=this._options.intUrl}}
